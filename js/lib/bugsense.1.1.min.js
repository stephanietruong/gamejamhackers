var bugsense;(function(a,b){if(typeof define==="function"&&define.amd){define(function(){return(a.Bugsense=b())})}else{a.Bugsense=b()}}(this,function(){var w=function w(C,B){return Object.keys(B).forEach(function(D){C[D]=B[D]})};var o=encodeURIComponent;var g=function g(B){return B instanceof Object};var h=function h(B){return B instanceof Array};var f=function f(B){return(typeof(B)=="string"||typeof(B)=="number"||typeof(B)=="boolean")};var s=function s(C,B){Array.prototype.forEach.call(Object.keys(C),function(D){B(D,C[D])})};var n=function n(E,D,C,B){var F=h(D);s(D,function(G,H){if(B){G=C?B:B+"["+(F?"":G)+"]"}if(!B&&F){E.add(H.name,H.value)}else{if(C?h(H):g(H)){n(E,H,C,G)}else{E.add(G,H)}}})};var e=function e(C,B){var D=[];D.add=function(F,E){this.push(o(F)+"="+o(E))};n(D,C,B);return D.join("&").replace(/%20/g,"+")};var q=function l(){var B=function(){return Math.floor(Math.random()*65536).toString(16)};return(B()+B()+"-"+B()+"-"+B()+"-"+B()+"-"+B()+B()+B())};var x=function(C){w(this.config,C);this.config.winjs=typeof(WinJS)!=="undefined";this.extraData={};this.breadcrumbs=[];bugsense=this;if(typeof(this.config.context.onerror)!=="undefined"){this.config.context.onerror=bugsense.onerror}if(this.config.winjs){WinJS.Promise.onerror=bugsense.onpremiseerror;var E=Windows.ApplicationModel.Package.current.id.version;this.config.appversion=[E.major,E.minor,E.build,E.revision].join(".");this.send_cached_report_if_any();var D=Windows.Storage.ApplicationData.current.localSettings;var B=D.guid;if(!B){B=q();D.guid=B}this.config.guid=B}return this};x.prototype.config={apiKey:"FOOBAR",url:"https://www.bugsense.com/api/errors",pingUrl:"http://ticks2.bugsense.com/api/ticks",appversion:null,popup:false,callback:null,context:window,winjs:null,message:null};x.prototype.addExtraData=function v(B,C){if(f(B)&&f(C)){this.extraData[B]=C}};x.prototype.removeExtraData=function p(B){delete this.extraData[B]};x.prototype.clearExtraData=function j(){this.extraData={}};x.prototype.leaveBreadcrumb=function t(B){if(f(B)){if(this.breadcrumbs.length+1==16){this.breadcrumbs=this.breadcrumbs.slice(1)}this.breadcrumbs.push(B)}};x.prototype.clearBreadcrumbs=function c(){this.breadcrumbs={}};x.prototype._die=function y(){throw"BugSense exited"};x.prototype.successHandler=function k(G){function B(){throw"BugSense exited"}if(G.target&&G.target.readyState!=4){return}if(G.target&&G.target.status!=200&&bugsense.config.winjs){return false}if("console" in window){console.log("logged 1 error to Bugsense, status: "+G.target.responseText)}if(bugsense.config.winjs){if(G.target.responseText!==undefined&&G.target.responseText.indexOf("url")>0){var F=JSON.parse(G.target.responseText);var I=new Windows.UI.Popups.MessageDialog(F.data.tickerText);var J,D=["Update","Cancel"];var E;for(var H=0;H<D.length;H++){E=new Windows.UI.Popups.UICommand();E.label=D[H];E.invoked=function(K){J=K.label};I.commands.append(E)}I.showAsync().then(function(L){if(L.label=="Update"){var K=Windows.Foundation.Uri(F.data.url);Windows.System.Launcher.launchUriAsync(K)}return L.label}).done(function C(){window.bugsense._die()})}else{if(G.target.responseText.length>0&&G.target.responseText.indexOf("url")<0){if(window.bugsense.config.message!==null){var I=new Windows.UI.Popups.MessageDialog(window.bugsense.config.message);var J,D=["OK"];var E;for(var H=0;H<D.length;H++){E=new Windows.UI.Popups.UICommand();E.label=D[H];E.invoked=function(K){J=K.label};I.commands.append(E)}I.showAsync().then(function(K){return K.label}).done(function C(){window.bugsense._die()})}else{window.bugsense._die()}}}}};x.prototype.getPostURL=function u(){return x.prototype.config.url+"?cacheBuster="+(new Date()).getTime()};x.prototype.parseError=function A(B){var F={};if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){F={message:B.message,url:window.location.href,line:B.lineNumber,stack:B.stack,type:B.name}}else{if(this.config.winjs===true&&typeof(B.stack)==="undefined"){F={message:B.detail.errorMessage,url:B.detail.errorUrl,line:B.detail.errorLine,stack:(B.detail.stack===undefined)?B.detail.errorMessage:B.detail.stack,type:B.detail.errorCode}}else{if(this.config.winjs===true&&typeof(B.stack)!=="undefined"){var D=B.stack;var C=D.substr(D.indexOf("(")+1,D.indexOf(")")-D.indexOf("(")-1).split(":");F={message:B.message,url:C[0]+":"+C[1],line:C[2],stack:B.stack,type:B.stack.split(":")[0],handled:true}}else{var E=B.stack.split("\n").slice(1)[0].match(/\s+at\s.*(\/.*\..*|<anonymous>:\d*:\d*)/);try{var C=B.stack}catch(B){B.stack=B.message}F={message:[B.name,B.message].join(": "),url:E[1].split(":")[0].replace("/",""),line:E[1].split(":")[1],stack:B.stack,type:B.name}}}}if(F.stack==null||(typeof(F.stack)=="string"&&F.stack.length==0)){F.stack=F.message}return F};x.prototype.generateExceptionData=function d(H,B,J,F,G){if(typeof(H)!="string"){H=H.toString()}var I=window.navigator.userAgent;var E="unknown";if(this.config.winjs){try{E=Windows.Networking.Connectivity.NetworkInformation.getInternetConnectionProfile().profileName}catch(C){E="Offline"}}else{if(typeof window.navigator.network!=="undefined"){E=window.navigator.network.connection.type}}var D={client:{name:"bugsense-js",version:"1.1"},request:{custom_data:G},exception:{message:H,where:[B,J].join(":"),klass:H.split(":")[0],backtrace:(typeof(F)==="undefined")?H:F,breadcrumbs:this.config.breadcrumbs},application_environment:{phone:window.navigator.platform,appver:(this.config.appversion||"unknown"),appname:(this.config.appname||"unknown"),osver:(typeof window.device!=="undefined")?window.device.version:I.substr(I.indexOf("; ")+2,I.length).replace(")",";").split(";")[0]||"unknown",connection_type:E,user_agent:window.navigator.userAgent,cordova:(typeof window.device!=="undefined")?window.device.cordova:"unknown",device_name:(typeof window.device!=="undefined")?window.device.name:"unknown",log_data:this.extraData}};if(this.config.winjs){D.application_environment.cpuClass=window.navigator.cpuClass;D.application_environment.osver=window.navigator.userAgent.split(";")[2];D.application_environment.languages=window.navigator.systemLanguage;D.application_environment.locale=window.navigator.userLanguage;D.application_environment.is_trial=Windows.ApplicationModel.Store.CurrentApp.licenseInformation.isTrial;D.application_environment.is_active=Windows.ApplicationModel.Store.CurrentApp.licenseInformation.isActive;D.application_environment.uid=this.config.guid;if(typeof(G)!=="undefined"){if(typeof(G.handled)!=="undefined"){D.exception.handled=0}}}return D};x.prototype.testException=function m(B){if(this.config.winjs===true&&typeof(B.detail)!=="undefined"){return B.type==="error"}return Object.prototype.toString.call(B)==="[object Error]"};x.prototype.isBugsenseException=function a(B){return this.config.winjs&&this.testException(B)&&B.detail.errorMessage==="BugSense exited"};x.prototype.notify=function r(F,D,C,I){var B;if(arguments.length===2&&this.testException(F)){I=D;D=undefined}if(this.testException(F)){var H=this.parseError(F);message=[H.type,H.message].join(":");D=H.url;C=H.line;B=H.stack;if(typeof(H.handled)!=="undefined"){if(typeof(I)!=="object"){I={}}I.handled=0}}else{message=F}var G=this.generateExceptionData(message,D,C,B,I);var E=new XMLHttpRequest();E.open("POST",this.getPostURL(),true);E.setRequestHeader("X-BugSense-Api-Key",this.config.apiKey);E.setRequestHeader("Content-Type","application/x-www-form-urlencoded");E.onerror=function(K){if(bugsense.config.winjs){WinJS.Application.local.writeText("CachedCrashReport",JSON.stringify(G)).done(function J(){console.log("written");window.bugsense._die()})}};if(!(I instanceof Object&&I.handled==0)){E.onreadystatechange=this.successHandler}E.send(e({data:JSON.stringify(G)}));return true};x.prototype.send_cached_report_if_any=function z(){var B=WinJS.Application.local;B.exists("CachedCrashReport").then(function(C){if(C){B.readText("CachedCrashReport").then(function(D){var F=JSON.parse(D);var E=new XMLHttpRequest();E.open("POST",window.bugsense.getPostURL(),true);E.setRequestHeader("X-BugSense-Api-Key",window.bugsense.config.apiKey);E.setRequestHeader("Content-Type","application/x-www-form-urlencoded");E.onreadystatechange=function(G){if(G.target&&G.target.readyState==4){WinJS.Application.local.remove("CachedCrashReport");return}};E.send(e({data:JSON.stringify(F)}))}).done()}}).done()};x.prototype.onerror=function b(D,C,B,E){if(window.bugsense.isBugsenseException(D)){return false}return window.bugsense.notify(D,C,B,E)};x.prototype.onpromiseerror=function i(B){if(window.bugsense.isBugsenseException(exception)){return false}return window.bugsense.notify(B.detail.exception,B.detail.promise)};return x}));