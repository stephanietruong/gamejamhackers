/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0020=function(){TGS.Adapters.A0020.superclass.constructor.call(this),this._mLoggedIn=!1,this._mMoreGamesURL=null,this._mSkipBackgroundEvent=!1,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1,this._mUseUserInfoInSLB=!0,this._mKikForIAPs=!0},TGS.Adapters.A0020.prototype={supportsMicrotransactions:function(){return!0},autoLogin:function(){return!1},supportsLogout:function(){return!1},loginIcon:function(){return TGS._IMAGES_LOCATION+"kik_login.png"},supportsChallenges:function(){return!0},challengeIcon:function(){return TGS._IMAGES_LOCATION+"kik.png"},costFactor:function(){return 10},priceAsFormattedString:function(a){return this._mKikForIAPs?"FREE!":"$"+(a*this.costFactor()/100-.01).toFixed(2)},formattedPriceForItem:function(){return"$"+(aPrice*this.costFactor()/100-.01).toFixed(2)},gameWasLaunched:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Kik gameWasLaunched"),window.cards&&cards.browser&&window.TGE&&TGE.Game.GetInstance()&&(cards.browser.on("background",this.onBackground.bind(this)),cards.browser.on("foreground",this.onForeground.bind(this)),TGE.Button.DefaultVerticalPressOffset=4)},onBackground:function(){if(this._mSkipBackgroundEvent)return this._mSkipBackgroundEvent=!1,void 0;if("undefined"!=typeof window.TGE&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();TGS.Debug.Log(TGS.Debug.LOG_INFO,"pausing the game and halting update loop"),TGE.Game.GetInstance().PauseGame(!0),a._mRAFID?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"cancelling requestAnimationFrame..."),cancelAnimationFrame(a._mRAFID),a._mRAFID=null):TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already null?"),TGS.Debug.Log(TGS.Debug.LOG_INFO,"disabling updates..."),a._mUpdatingEnabled=!1}},onForeground:function(){if("undefined"!=typeof window.TGE&&TGE.Game.GetInstance()){var a=TGE.Game.GetInstance();null===a._mRAFID?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"restarting requestAnimationFrame..."),a._mRAFID="undefined"!=typeof a.Update?requestAnimationFrame(a.Update.bind(a)):requestAnimationFrame(a._update.bind(a))):TGS.Debug.Log(TGS.Debug.LOG_INFO,"requestAnimationFrame was already active?"),TGS.Debug.Log(TGS.Debug.LOG_INFO,"turning updating back on with a 30 frame delay"),a._mUpdatingEnabled=!0,a._mUpdateSkips=30}},initialize:function(){navigator.onLine===!1&&(TGS.Debug.Log(TGS.Debug.LOG_WARNING,"navigator.onLine is false - TGS going into OFFLINE mode"),TGS._sOnline=!1),window.cards&&cards.kik||TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Kik cards module was not loaded, or game is not being played in Kik Messenger"),window.cards&&cards.metrics&&cards.metrics.enableGoogleAnalytics("UA-29301358-44","kik.tresensa.com");var a="landscape";window.cards&&cards.kik&&("undefined"!=typeof window.GameConfig&&GameConfig.ORIENTATION&&(a=GameConfig.ORIENTATION),cards.browser.setOrientationLock(a)),kik.browser.statusBar(!1),kik.browser.backlightTimeout(!1),this._mIsReady=!0,null!==this.onAdapterReady&&this.onAdapterReady.call()},connect:function(){if(window.cards&&cards.purchase){for(var a=[],b=TGS.Microtransactions.GetIAPProducts(),c=0;c<b.length;c++)b[c].partnerProductID&&a.push(b[c].partnerProductID);TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"requesting Kik IAP items: "+a.toString()),cards.purchase.init(a)}else TGS.Debug.Log(TGS.Debug.LOG_WARNING,"Kik IAP is unavailable");this.getLoginStatus()},loginUser:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"prompting user to link to their Kik account..."),this._mSkipBackgroundEvent=!0,cards.kik.getUser(this.onLinkToKik.bind(this,a))},onLinkToKik:function(a,b){return this._mSkipBackgroundEvent=!1,b?"string"!=typeof b.username||b.username.length<1?(TGS._LoginFailed(a),void 0):(this._mUsername=b.username,this._mAvatarURL=b.thumbnail,this.userLoggedIn(a,b.username),void 0):(TGS._LoginCanceled(a),void 0)},purchaseItem:function(a){if(this._mKikForIAPs)TGS.OverlayMessage({title:"Special Offer!",message:"To unlock this item for FREE just kik the game to a friend:",buttonText:"",buttonAction:this.kikToPurchaseCancelled.bind(this,a),button2Image:TGS._IMAGES_LOCATION+"kik_iap.png",button2Callback:this.kikToPurchase.bind(this,a)});else{if(!cards.purchase)return a.internalErrorMessage="Kik IAP unavailable",a.userErrorMessage="In-app purchases are not available on this version of Kik Messenger.",TGS.Microtransactions._PartnerPurchaseFailed(a),void 0;var b=TGS.Microtransactions.GetIAPProduct(a.item.id);if(!b.partnerProductID)return a.internalErrorMessage="no Kik product id",a.userErrorMessage="Sorry, this item is not available on Kik Messenger yet.",TGS.Microtransactions._PartnerPurchaseFailed(a),void 0;var c={transaction:a.transactionID};cards.purchase(b.partnerProductID,c,this.onPurchaseResponse.bind(this,a))}},onPurchaseResponse:function(a,b){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseResponse: "+JSON.stringify(b)),b?"string"!=typeof b.transactionId?(a.internalErrorMessage="Kik purchase failed - invalid transaction id",TGS.Microtransactions._PartnerPurchaseFailed(a)):(TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"transaction content: "+JSON.stringify(b.content)),a.partnerTransactionID=b.transactionId,TGS.Debug.Log(TGS.Debug.LOG_INFO,"Kik approved purchase of transaction "+a.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(a)):(a.internalErrorMessage="Kik purchase failed - no transaction object",a.userErrorMessage="The transaction was not completed.",TGS.Microtransactions._PartnerPurchaseFailed(a))},kikToPurchase:function(a){var b="undefined"!=typeof window.GameConfig&&"string"==typeof window.GameConfig.TITLE?window.GameConfig.TITLE:null,c=b?b:"Check out this game!";cards.kik.send({title:c,text:"Check out this game I'm playing on Kik right now - it's awesome!"}),TGS.CloseMessageOverlay(),a.partnerTransactionID="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)}),TGS.Debug.Log(TGS.Debug.LOG_INFO,"user did a Kik-it to complete purchase of transaction "+a.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(a)},kikToPurchaseCancelled:function(a){a.internalErrorMessage="user didn't kik",a.userErrorMessage="",TGS.Microtransactions._PartnerPurchaseFailed(a)},purchaseComplete:function(a){this._mKikForIAPs||cards.purchase.complete(a.partnerTransactionID)},challenge:function(a){cards.kik.send({title:a.title,text:a.message})},share:function(a,b){return alert('share"'),"kik"!=a?(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Attempting to share to "+a+". Only kik is allowed."),void 0):(console.log(b),cards.kik.send({title:b.title,text:b.msg,pic:b.image}),void 0)},getShareServices:function(){return[{id:"kik",title:"Kik Messenger",label:"Kik it"}]},advertising_injectAd:function(a,b){a.element=document.createElement("div"),a.element.id="tgs_display_ad",a.element.style.position="absolute",a.element.style.zIndex=3,a.element.style.webkitTransformOrigin="center center",a.element.style.MozTransformOrigin="center center",a.element.style.msTransformOrigin="center center",a.element.style.OTransformOrigin="center center",a.element.style.transformOrigin="center center",a._reposition(b);var c="<div id='tgs_display_ad_iframe' style='width: "+a.width+"px; height: "+a.height+"px; border: none; overflow: hidden;'><a style='display: block; width:100%; height:100%;' href='http://kik.tresensa.com/moregames/index.html' target='_blank' ontouchstart='console.log(\"Opening\"); cards.kik.open(\"http://kik.tresensa.com/moregames/index.html\"); event.preventDefault();'><img style='width: 100%;' src='https://sdk.tresensa.com/tgs/images/kik-moregames.png'/></a></div>";a.element.innerHTML=c,b.insertBefore(a.element,b.firstChild)},advertising_injectInterstitial:function(a){a.closeCallback&&a.closeCallback()}},extend(TGS.Adapters.A0020,TGS.PartnerBridge);