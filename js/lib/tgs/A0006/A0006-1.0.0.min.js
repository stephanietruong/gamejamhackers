/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0006=function(){TGS.Adapters.A0006.superclass.constructor.call(this),"undefined"!=typeof window.TGE&&(TGE.DisableViewportResizing=!0,TGE.DisableLostFocusPause=!0),this._mDoDoubleResize=!0},TGS.Adapters.A0006.prototype={supportsMicrotransactions:function(){return!0},costFactor:function(){return 10},currencyIcon:function(){return TGS._IMAGES_LOCATION+"mocogold.png"},priceAsFormattedString:function(a){return(a*this.costFactor()).toString()+" Gold"},serverHandlesMicrotransactionResponse:function(){return!0},gameWasLaunched:function(){this._forceResizeIFrame()},initialize:function(){window.MocoSpace||TGS.Debug.Log(TGS.Debug.LOG_ERROR,"MocoSpace library has not been loaded"),MocoSpace.registerOrientationListener(this._resizeGameIFrame.bind(this)),MocoSpace.getViewPort(this._resizeGameIFrame.bind(this)),this._mIsReady=!0,null!==this.onAdapterReady&&this.onAdapterReady.call()},_resizeGameIFrame:function(a,b){"undefined"!=typeof window.TGE&&TGE.Game.GetInstance()&&(TGE.Game.GetInstance()._resizeToFit(b,a),this._mDoDoubleResize&&"Android"===TGE.BrowserDetect.platform&&"Mozilla"===TGE.BrowserDetect.browser?(setTimeout(this._forceResizeIFrame.bind(this),500),this._mDoDoubleResize=!1):this._mDoDoubleResize=!0)},_forceResizeIFrame:function(){MocoSpace.getViewPort(this._resizeGameIFrame.bind(this))},connect:function(){if(TGS._sFakeConnections){TGS.Debug.Log(TGS.Debug.LOG_INFO,"giving fake Mocospace user info to TGS");var a="56421477";return null!==this.onUserInfoAvailable&&this.onUserInfoAvailable.call(this,a),void 0}TGS.Debug.Log(TGS.Debug.LOG_INFO,"fetching player info...");var b={};b[opensocial.PeopleRequestFields.PROFILE_DETAILS]=[],opensocial.fetchPerson("@me",b,this.onFetchPerson.bind(this))},onFetchPerson:function(a){if(a.hadError())TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not retrieve user id: "+a.getErrorMessage());else{var b=a.getData().getField(opensocial.Person.Field.ID);null!==this.onUserInfoAvailable&&this.onUserInfoAvailable.call(this,b)}},purchaseItem:function(a){var b=this.getImageURL(a),c=a.item.price*this.costFactor();MocoSpace.goldTransaction(c,a.item.title,{onSuccess:this._onPurchaseSuccess.bind(this,a),onError:this._onPurchaseError.bind(this,a),onAbort:this._onPurchaseAbort.bind(this,a),onAsync:this._onPurchaseAsync.bind(this,a)},b)},_onPurchaseSuccess:function(a,b,c,d){a.partnerTransactionID=b;var e=a.item,f=e.price*this.costFactor(),g='{"moco_transaction_token":"'+d+'","moco_transaction_id":"'+b+'","moco_transaction_cost":"'+f+'","moco_transaction_timestamp":"'+c+'","game":"'+TGS._sGameID+'","tresensa_transaction_id":'+a.transactionID+',"user":"'+TGS._sUserID+'","game_data_changes":'+JSON.stringify(a.gameDataUpdates)+"}";TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending successful purchase data for verification: "+g),TGS.SendMessage("mtx/mocospace/callback","verify",g,this._onVerificationSuccess.bind(this,a),this._onVerificationError.bind(this,a))},_onVerificationSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Mocospace token was verified"),TGS.Microtransactions._PartnerPurchaseSuccessful(a)},_onVerificationError:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Mocospace token verification failed"),a.internalErrorMessage="Mocospace token verification failed",TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseError:function(a,b){a.internalErrorMessage="Mocospace error: "+b,TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseAbort:function(a){a.internalErrorMessage="user cancelled",a.userErrorMessage="",TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseAsync:function(a){a.internalErrorMessage="insufficient funds",a.userErrorMessage="",TGS.Microtransactions._PartnerPurchaseFailed(a)}},extend(TGS.Adapters.A0006,TGS.PartnerBridge);