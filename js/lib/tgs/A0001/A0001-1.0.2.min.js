/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0001=function(){TGS.Adapters.A0001.superclass.constructor.call(this),this._mGameCenterCloseCallback=null,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1,TGS._sContinueOnPartnerInfoFail=!0},TGS.Adapters.A0001.prototype={loginIcon:function(){return TGS._IMAGES_LOCATION+"ios_login.png"},supportsMicrotransactions:function(){return!0},allowsMicrotransactions:function(){return TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - allowsMicrotransactions: "+this._isPurchaseAllowed),this._isPurchaseAllowed},implementsLeaderboard:function(){return!0},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+(a*this.costFactor()/100-.01).toFixed(2)},setIAPProducts:function(){(null==TGS.Microtransactions._sIAPProducts||TGS.Microtransactions._sIAPProducts.length<1)&&(TGS.Microtransactions._sIAPProducts=[])},initialize:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.initialize called, initializing iOS App Store Adapter"),this._availableProducts=null,window.plugins&&(window.plugins.InAppPurchaseManager.setup(),document.addEventListener("onInAppPurchaseSuccess",this._onPurchase.bind(this),!1),document.addEventListener("onInAppPurchaseFailed",this._onPurchaseFailed.bind(this),!1),document.addEventListener("onInAppPurchaseRestored",this._onPurchaseRestored.bind(this),!1),document.addEventListener("onRestoreCompletedTransactionsFinished",this._onRestorePurchasesFinished.bind(this),!1),document.addEventListener("onRestoreCompletedTransactionsFailed",this._onRestorePurchasesFailed.bind(this),!1),window.plugins.InAppPurchaseManager.canPurchase(this.userAllowsPurchase.bind(this))),this._mIsReady=!0,null!==this.onAdapterReady&&this.onAdapterReady.call()},_onPurchase:function(a){{var b=a.transactionId,c=a.productId;a.transactionReceipt}TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - onPurchased: "+c);var d=TGS.Microtransactions._PendingRequest;d?c!=d.item.partnerProductID?(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - onPurchased is waiting for "+d.item.partnerProductID+" but got "+c),d.internalErrorMessage="incorrect item id",TGS.Microtransactions._PartnerPurchaseFailed(d)):(d.partnerTransactionID=b,TGS.Debug.Log(TGS.Debug.LOG_INFO,"Apple approved purchase of transaction "+d.transactionID+", "+d.partnerTransactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(d)):TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - onPurchased has no pending request")},_onPurchaseRestored:function(a){var b=a.transactionId,c=a.productId,d=a.transactionReceipt;TGS.Debug.Log(TGS.Debug.LOG_INFO,"InAppPurchase Manager - restore purchase received for iOS sku "+c),TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"transactionIdentifier: "+b),TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"transactionReceipt: "+d);for(var e=0;e<TGS.Microtransactions._sIAPProducts.length;e++){var f=TGS.Microtransactions._sIAPProducts[e];if(f.partnerProductID==c)return TGS.Microtransactions._RestorePurchaseCallback(f.id),void 0}TGS.Debug.Log(TGS.Debug.LOG_ERROR,"did not recognize iOS sku "+c)},_onRestorePurchasesFinished:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"_onRestorePurchasesFinished called"),TGS.Microtransactions._RestorePurchasesDone(!0)},_onRestorePurchasesFailed:function(a){{var b=a.errorMsg;a.errorCode}TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"_onRestorePurchasesFailed called with error: "+b),TGS.Microtransactions._RestorePurchasesDone(!1)},_onPurchaseFailed:function(a){{var b=a.errorMsg;a.errorCode}TGS.Debug.Log(TGS.Debug.LOG_ERROR,"InAppPurchase Manager - failed: "+b);var c=TGS.Microtransactions._PendingRequest;c&&(c.internalErrorMessage=b,TGS.Microtransactions._PartnerPurchaseFailed(c))},_gameCenterOnShow:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"GameCenter triggered onshow")},_gameCenterOnHide:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"GameCenter triggered onhide"),this._mGameCenterCloseCallback&&this._mGameCenterCloseCallback.call()},initFacebook:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.initFacebook called"),window.FB&&!this._mFacebookInitialized&&this._mFacebookAppID&&"undefined"!=typeof window.CDV&&(TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.initFacebook calling FB.init, appId = "+this._mFacebookAppID),FB.init({appId:this._mFacebookAppID,nativeInterface:CDV.FB,useCachedDialogs:!1}),this._mFacebookInitialized=!0)},connect:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"IOSAppStoreAdapter.connect called"),this._mFacebookInitialized||this.initFacebook(),window.plugins&&(this.setIAPProducts(),this.getIAPProductsResponse(TGS.Microtransactions.GetIAPProducts(),null),window.gameCenter&&Object.keys(TGS.Leaderboard.GetLeaderboardDescriptors()).length>0&&(window.gameCenter.onshow=this._gameCenterOnShow.bind(this),window.gameCenter.onhide=this._gameCenterOnHide.bind(this),window.gameCenter.authenticate(this.authSuccess.bind(this),this.authFailure.bind(this))),this._mAdxId=CordovaConfig&&CordovaConfig.ADS&&CordovaConfig.ADS.ADX_PLACEMENT_ID,plugins.adxPlugin&&this._mAdxId&&plugins.adxPlugin.init(this._mAdxId)),this.updateLocalStorageData(),this.getLoginStatus()},getIAPProductsResponse:function(a,b){if(null!=b)TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts error "+b.message);else if(null!=a&&a.length>0){TGS.Debug.Log(TGS.Debug.LOG_INFO,"getIAPProducts success with "+a),this._availableProducts=a;for(var c=[],d=0;d<a.length;d++){var e=a[d];null!=e.partnerProductID&&e.partnerProductID.length>0?(c[d]=e.partnerProductID,TGS.Debug.Log(TGS.Debug.LOG_INFO,"getIAPProducts added "+e.partnerProductID)):TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts error partnerProductID is null for "+e.title)}c.length>0?this.getIAPProductsInfo(c):TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts no products defined!")}else TGS.Debug.Log(TGS.Debug.LOG_ERROR,"getIAPProducts got no products!"),this._availableProducts=null},getIAPProductsInfo:function(a){"String"===Object.prototype.toString.call(a).slice(8,-1)&&(TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Single IAP id converting to array"),a=[a]),TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"Calling IAP requestProductData"),window.plugins.InAppPurchaseManager.requestProductData(a,function(a,b){for(var c="",d=0;d<a.length;d++){c+=c.length>0?", ":"[";var e=a[d];c+='{id:"'+e.id+'", decription:"'+e.description+'", price:"'+e.price+'"}'}c+="]",null!=b&&b.length>0?TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase requestProductsData: "+c+"; Invalids="+b):TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase requestProductsData: "+c)})},userAllowsPurchase:function(a){this._isPurchaseAllowed=a,TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchase Manager - canPurchase: "+this._isPurchaseAllowed)},purchaseItem:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"iOS purchase request for "+a.item.id+" ("+a.item.partnerProductID+").");var b=a.item.partnerProductID,c=1;window.plugins.InAppPurchaseManager.makePurchase(b,c)},restorePurchases:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"InAppPurchaseManager calling restoreCompletedTransactions..."),window.plugins.InAppPurchaseManager.restoreCompletedTransactions()},submitScore:function(a){var b=a.leaderboardID?a.leaderboardID:0,c=TGS.Leaderboard.GetLeaderboardDescriptor(b);if(null===c)return TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no data found for leaderboard id "+a.leaderboardID),void 0;var d=c.partnerLeaderboardID;return null===d?(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no iOS sku found for leaderboard id "+a.leaderboardID),void 0):window.gameCenter?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"submitting score "+a.score+" to GameCenter leaderboard "+d),window.gameCenter.reportScore(d,a.score,this.scoreSuccess.bind(this),this.scoreFailure.bind(this)),void 0):(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter module is not available"),void 0)},showLeaderboard:function(a){var b=a.leaderboardID?a.leaderboardID:0,c=TGS.Leaderboard.GetLeaderboardDescriptor(b);if(null===c)return TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no data found for leaderboard id "+a.leaderboardID),void 0;var d=c.partnerLeaderboardID;return null===d?(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no iOS sku found for leaderboard id "+a.leaderboardID),void 0):window.gameCenter?(this._mGameCenterCloseCallback=a.onClose,TGS.Debug.Log(TGS.Debug.LOG_INFO,"showing GameCenter leaderboard "+d+"..."),window.gameCenter.showLeaderboard(d),void 0):(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter module is not available"),void 0)},submitScoreAndShow:function(a){var b=a.leaderboardID?a.leaderboardID:0,c=TGS.Leaderboard.GetLeaderboardDescriptor(b);if(null===c)return TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no data found for leaderboard id "+a.leaderboardID),void 0;var d=c.partnerLeaderboardID;return null===d?(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"no iOS sku found for leaderboard id "+a.leaderboardID),void 0):window.gameCenter?(this._mGameCenterCloseCallback=a.onClose,TGS.Debug.Log(TGS.Debug.LOG_INFO,"submitting score "+a.score+" to GameCenter leaderboard "+d),window.gameCenter.reportScore(d,a.score,this.scoreSuccessShowLeaderboard.bind(this,d),this.scoreFailure.bind(this)),void 0):(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter module is not available"),void 0)},achievementEarned:function(){},scoreSuccessShowLeaderboard:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter score reported, showing leaderboard..."),window.gameCenter.showLeaderboard(a)},scoreSuccess:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter score reported")},scoreFailure:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter score failure: "+a)},achievementSuccess:function(){window.gameCenter.showAchievements(),TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter get achievement success")},achievementFailure:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter get achievement failure:\n"+a)},authSuccess:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"GameCenter Authentication success")},authFailure:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"GameCenter Authentication failure:\n"+a+"\nPlease sign in using the Game Center application")},requestAuthorization:function(){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"GameCenter requestAuthorization called"),window.gameCenter.authenticate(this.authSuccess.bind(this),this.authFailure.bind(this))},advertising_injectAd:function(a,b){if(this._mAdxId){var c=b.clientWidth,d=b.clientHeight,e="undefined"==typeof a.x?(b.clientWidth-a.width)/2:a.x,f="undefined"==typeof a.y?(b.clientHeight-a.height)/2:a.y,g=90===Math.abs(window.orientation)?"landscape":"portrait";plugins.adxPlugin.getAd(c,d,e,f,g,function(){})}},advertising_injectInterstitial:function(a){loadingOverlay=TGS.LoadingOverlay(),plugins.adxPlugin.showInterstitial(function(){loadingOverlay.parentNode.removeChild(loadingOverlay),a.closeCallback&&a.closeCallback()})},advertising_closeAd:function(){this._mAdxId&&plugins.adxPlugin.closeAd()},analytics_getProviders:function(){return[TGS.Analytics.NativeGoogleAnalyticsProvider]}},extend(TGS.Adapters.A0001,TGS.PartnerBridge);