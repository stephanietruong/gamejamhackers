/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0027=function(){TGS.Adapters.A0027.superclass.constructor.call(this),this._mJooistUserID=getQueryString().uid,this._mSessionID=null},TGS.Adapters.A0027.prototype={supportsMicrotransactions:function(){return!0},costFactor:function(){return 100},currencyIcon:function(){return TGS._IMAGES_LOCATION+"jooist.png"},priceAsFormattedString:function(a){return(a*this.costFactor()).toString()+" credits"},serverHandlesMicrotransactionResponse:function(){return!0},implementsLeaderboard:function(){return!0},connect:function(){if(this._mJooistUserID)if(token=getQueryString().token){var a='{"game":"'+TGS._sGameID+'","jooist_user":"'+this._mJooistUserID+'","token":"'+token+'"}';TGS.SendMessage("partners/jooist/bridge","session_validate",a,this._onSessionValidateSuccess.bind(this),this._onSessionValidateFailure.bind(this))}else TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Jooist token missing");else TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Jooist user ID missing")},_onSessionValidateSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Jooist session validation succeeded: "+a.session_id),this._mSessionID=a.session_id,null!==this.onUserInfoAvailable&&this.onUserInfoAvailable.call(this,this._mJooistUserID)},_onSessionValidateFailure:function(){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Jooist session validation failed")},showLeaderboard:function(a){leaderboardID=this._getAdjustedLeaderboardID(a);var b="function"==typeof a.onFailure?a.onFailure:null,c=new TGS.LeaderboardRequest;c.type="get",c.params=a,c.onSuccess=TGS.Leaderboard._PopulateLeaderboard.bind(this),c.onFailure=TGS.Leaderboard._RetrieveScoresFailed.bind(this,b),c.slbDivs=TGS.Leaderboard._OpenEmptyLeaderboard(c);var d='{"game":"'+TGS._sGameID+'","jooist_user":"'+this._mJooistUserID+'","leaderboard":"'+leaderboardID+'","period":"'+a.timePeriod+'","page":"'+a.page+'"}';TGS.SendMessage("partners/jooist/bridge","get_scores",d,TGS.Leaderboard._SuccessCallback.bind(this,c),TGS.Leaderboard._ErrorCallback.bind(this,c))},submitScore:function(a){var b=null;b=this._getAdjustedLeaderboardID(a);var c='{"game":"'+TGS._sGameID+'","session_id":"'+this._mSessionID+'","leaderboard":"'+b+'","score":"'+a.score+'"}';TGS.SendMessage("partners/jooist/bridge","submit_score",c,this._onSubmitScoreSuccess.bind(this),this._onSubmitScoreFailure.bind(this))},_onSubmitScoreSuccess:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Jooist score submission succeeded")},_onSubmitScoreFailure:function(){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Jooist score submission failed")},submitScoreAndShow:function(a){leaderboardID=this._getAdjustedLeaderboardID(a);var b="function"==typeof a.onFailure?a.onFailure:null,c=new TGS.LeaderboardRequest;c.type="get",c.params=a,c.onSuccess=TGS.Leaderboard._PopulateLeaderboard.bind(this),c.onFailure=TGS.Leaderboard._RetrieveScoresFailed.bind(this,b),c.slbDivs=TGS.Leaderboard._OpenEmptyLeaderboard(c);var d='{"game":"'+TGS._sGameID+'","session_id":"'+this._mSessionID+'","leaderboard":"'+leaderboardID+'","score":"'+a.score+'","jooist_user":"'+this._mJooistUserID+'","period":"'+a.timePeriod+'","page":"'+a.page+'"}';TGS.SendMessage("partners/jooist/bridge","submit_score",d,TGS.Leaderboard._SuccessCallback.bind(this,c),TGS.Leaderboard._ErrorCallback.bind(this,c))},purchaseItem:function(a){var b='{"game":"'+TGS._sGameID+'","jooist_user":"'+this._mJooistUserID+'"}';TGS.SendMessage("partners/jooist/bridge","check_balance",b,this._onCheckBalanceSuccess.bind(this,a),this._onCheckBalanceFailure.bind(this,a))},_onCheckBalanceSuccess:function(a,b){var c=a.item.price*this.costFactor();if(b.credits>=c){var d='{"game":"'+TGS._sGameID+'","tresensa_transaction_id":"'+a.transactionID+'","user":"'+TGS._sUserID+'","jooist_user":"'+this._mJooistUserID+'","credits":"'+c+'","game_data_changes":'+JSON.stringify(a.gameDataUpdates)+"}";TGS.SendMessage("partners/jooist/bridge","purchase",d,this._onPurchaseSuccess.bind(this,a),this._onPurchaseFailure.bind(this,a))}else a.internalErrorMessage="insufficient funds",a.userErrorMessage="You need "+(c-b.credits)+" additional credits to purchase this item.",TGS.Microtransactions._PartnerPurchaseFailed(a)},_onCheckBalanceFailure:function(a,b,c){a.internalErrorMessage="Credit balance check failed","undefined"!=typeof c.message&&(a.internalErrorMessage+=" - "+c.message),TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseSuccess:function(a){TGS.Microtransactions._PartnerPurchaseSuccessful(a)},_onPurchaseFailure:function(a,b,c){a.internalErrorMessage="Jooist purchase failed","undefined"!=typeof c.message&&(a.internalErrorMessage+=" - "+c.message),a.userErrorMessage="",TGS.Microtransactions._PartnerPurchaseFailed(a)},_getAdjustedLeaderboardID:function(a){return"undefined"==typeof a.leaderboardID?1:a.leaderboardID+1}},extend(TGS.Adapters.A0027,TGS.PartnerBridge);