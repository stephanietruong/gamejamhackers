/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0011=function(){TGS.Adapters.A0011.superclass.constructor.call(this),this._mAllowSandboxMode=!1,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1},TGS.Adapters.A0011.prototype={supportsMicrotransactions:function(){return!0},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+(a*this.costFactor()/100-.01).toFixed(2)},requiredPartnerProperties:function(){return'"amazon_sandbox_mode"'},initialize:function(){window.amzn_wa||TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Amazon library has not been loaded"),this._mIsReady=!0,null!==this.onAdapterReady&&this.onAdapterReady.call()},connect:function(a){this._mAllowSandboxMode=1===a.amazon_sandbox_mode,this.getLoginStatus(),amzn_wa.IAP?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"registering observers..."),amzn_wa.IAP.registerObserver({onSdkAvailable:this.onSDKAvailable.bind(this),onGetUserIdResponse:this.onGetUserIDResponse.bind(this),onItemDataResponse:this.onItemDataResponse.bind(this),onPurchaseResponse:this.onPurchaseResponse.bind(this),onPurchaseUpdatesResponse:this.onPurchaseUpdatesResponse.bind(this)})):TGS.Debug.Log(TGS.Debug.LOG_ERROR,"Amazon IAP module is not available")},onSDKAvailable:function(a){var b=!1;return"undefined"!=typeof window.GameConfig&&GameConfig.PROD_ENV===!0&&(b=!0),b&&!this._mAllowSandboxMode&&a.isSandboxMode?(TGS.Debug.Log(TGS.Debug.LOG_ERROR,"the Amazon Tester App cannot be used on a game deployed for production"),void 0):(TGS.Debug.Log(TGS.Debug.LOG_INFO,"Amazon SDK is ready, requesting user id..."),amzn_wa.IAP.getUserId(),void 0)},onGetUserIDResponse:function(a){a.getUserIdRequestStatus===amzn_wa.IAP.UserIdStatus.SUCCESSFUL?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"Amazon user id: "+a.userId),this.userLoggedIn(new TGS.LoginRequest,a.userId)):TGS.Debug.Log(TGS.Debug.LOG_ERROR,"could not retrieve Amazon user id")},onItemDataResponse:function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onItemDataResponse: "+JSON.stringify(a))},onPurchaseResponse:function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseResponse: "+JSON.stringify(a));var b=TGS.Microtransactions._PendingRequest;return b?(a.purchaseRequestStatus===amzn_wa.IAP.PurchaseStatus.SUCCESSFUL?(b.partnerTransactionID=a.receipt.purchaseToken,TGS.Debug.Log(TGS.Debug.LOG_INFO,"Amazon approved purchase of transaction "+b.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(b)):(b.internalErrorMessage="Amazon request status: "+a.purchaseRequestStatus,TGS.Microtransactions._PartnerPurchaseFailed(b)),void 0):(TGS.Debug.Log(TGS.Debug.LOG_WARNING,"received an unrequested purchase response: "+JSON.stringify(a)),void 0)},onPurchaseUpdatesResponse:function(a){TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"onPurchaseUpdatesResponse: "+JSON.stringify(a));for(var b=0;b<a.receipts.length;b++);},purchaseItem:function(a){if(!window.amzn_wa||!window.amzn_wa.IAP)return a.internalErrorMessage="Amazon SDK was unavailable",a.userErrorMessage="Could not connect to Amazon - make sure the Amazon Appstore app is running and restart the game.",TGS.Microtransactions._PartnerPurchaseFailed(a),void 0;var b=TGS._sGameID+"."+a.item.id.toString();TGS.Debug.Log(TGS.Debug.LOG_INFO,"requesting purchase for SKU item: "+b+" from Amazon..."),amzn_wa.IAP.purchaseItem(b)}},extend(TGS.Adapters.A0011,TGS.PartnerBridge);