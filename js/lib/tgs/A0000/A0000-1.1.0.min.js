/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
function X2JS(a){function b(){void 0===a.escapeMode&&(a.escapeMode=!0),a.attributePrefix=a.attributePrefix||"_",a.arrayAccessForm=a.arrayAccessForm||"none",a.emptyNodeForm=a.emptyNodeForm||"text",void 0===a.enableToStringFunc&&(a.enableToStringFunc=!0),a.arrayAccessFormPaths=a.arrayAccessFormPaths||[],void 0===a.skipEmptyTextNodesForObj&&(a.skipEmptyTextNodesForObj=!0),void 0===a.stripWhitespaces&&(a.stripWhitespaces=!0),a.datetimeAccessFormPaths=a.datetimeAccessFormPaths||[]}function c(){function a(a){var b=String(a);return 1===b.length&&(b="0"+b),b}"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|^\n+|(\s|\n)+$/g,"")}),"function"!=typeof Date.prototype.toISOString&&(Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"})}function d(a){var b=a.localName;return null==b&&(b=a.baseName),(null==b||""==b)&&(b=a.nodeName),b}function e(a){return a.prefix}function f(a){return"string"==typeof a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):a}function g(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}function h(b,c,d){switch(a.arrayAccessForm){case"property":b[c+"_asArray"]=b[c]instanceof Array?b[c]:[b[c]]}if(!(b[c]instanceof Array)&&a.arrayAccessFormPaths.length>0){for(var e=0;e<a.arrayAccessFormPaths.length;e++){var f=a.arrayAccessFormPaths[e];if("string"==typeof f){if(f==d)break}else if(f instanceof RegExp){if(f.test(d))break}else if("function"==typeof f&&f(b,c,d))break}e!=a.arrayAccessFormPaths.length&&(b[c]=[b[c]])}}function i(a){var b=a.split(/[-T:+Z]/g),c=new Date(b[0],b[1]-1,b[2]),d=b[5].split(".");if(c.setHours(b[3],b[4],d[0]),d.length>1&&c.setMilliseconds(d[1]),b[6]&&b[7]){var e=60*b[6]+Number(b[7]),f=/\d\d-\d\d:\d\d$/.test(a)?"-":"+";e=0+("-"==f?-1*e:e),c.setMinutes(c.getMinutes()-e-c.getTimezoneOffset())}else-1!==a.indexOf("Z",a.length-1)&&(c=new Date(Date.UTC(c.getFullYear(),c.getMonth(),c.getDate(),c.getHours(),c.getMinutes(),c.getSeconds(),c.getMilliseconds())));return c}function j(b,c,d){if(a.datetimeAccessFormPaths.length>0){for(var e=d.split(".#")[0],f=0;f<a.datetimeAccessFormPaths.length;f++){var g=a.datetimeAccessFormPaths[f];if("string"==typeof g){if(g==e)break}else if(g instanceof RegExp){if(g.test(e))break}else if("function"==typeof g&&g(obj,c,e))break}return f!=a.datetimeAccessFormPaths.length?i(b):b}return b}function k(b,c){if(b.nodeType==w.DOCUMENT_NODE){for(var f=new Object,i=b.childNodes,l=0;l<i.length;l++){var m=i.item(l);if(m.nodeType==w.ELEMENT_NODE){var n=d(m);f[n]=k(m,n)}}return f}if(b.nodeType==w.ELEMENT_NODE){var f=new Object;f.__cnt=0;for(var i=b.childNodes,l=0;l<i.length;l++){var m=i.item(l),n=d(m);m.nodeType!=w.COMMENT_NODE&&(f.__cnt++,null==f[n]?(f[n]=k(m,c+"."+n),h(f,n,c+"."+n)):(null!=f[n]&&(f[n]instanceof Array||(f[n]=[f[n]],h(f,n,c+"."+n))),f[n][f[n].length]=k(m,c+"."+n)))}for(var o=0;o<b.attributes.length;o++){var p=b.attributes.item(o);f.__cnt++,f[a.attributePrefix+p.name]=p.value}var q=e(b);return null!=q&&""!=q&&(f.__cnt++,f.__prefix=q),null!=f["#text"]&&(f.__text=f["#text"],f.__text instanceof Array&&(f.__text=f.__text.join("\n")),a.escapeMode&&(f.__text=g(f.__text)),a.stripWhitespaces&&(f.__text=f.__text.trim()),delete f["#text"],"property"==a.arrayAccessForm&&delete f["#text_asArray"],f.__text=j(f.__text,n,c+"."+n)),null!=f["#cdata-section"]&&(f.__cdata=f["#cdata-section"],delete f["#cdata-section"],"property"==a.arrayAccessForm&&delete f["#cdata-section_asArray"]),1==f.__cnt&&null!=f.__text?f=f.__text:0==f.__cnt&&"text"==a.emptyNodeForm?f="":f.__cnt>1&&null!=f.__text&&a.skipEmptyTextNodesForObj&&(a.stripWhitespaces&&""==f.__text||""==f.__text.trim())&&delete f.__text,delete f.__cnt,!a.enableToStringFunc||null==f.__text&&null==f.__cdata||(f.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),f}return b.nodeType==w.TEXT_NODE||b.nodeType==w.CDATA_SECTION_NODE?b.nodeValue:void 0}function l(b,c,d,e){var g="<"+(null!=b&&null!=b.__prefix?b.__prefix+":":"")+c;if(null!=d)for(var h=0;h<d.length;h++){var i=d[h],j=b[i];a.escapeMode&&(j=f(j)),g+=" "+i.substr(a.attributePrefix.length)+"='"+j+"'"}return g+=e?"/>":">"}function m(a,b){return"</"+(null!=a.__prefix?a.__prefix+":":"")+b+">"}function n(a,b){return-1!==a.indexOf(b,a.length-b.length)}function o(b,c){return"property"==a.arrayAccessForm&&n(c.toString(),"_asArray")||0==c.toString().indexOf(a.attributePrefix)||0==c.toString().indexOf("__")||b[c]instanceof Function?!0:!1}function p(a){var b=0;if(a instanceof Object)for(var c in a)o(a,c)||b++;return b}function q(b){var c=[];if(b instanceof Object)for(var d in b)-1==d.toString().indexOf("__")&&0==d.toString().indexOf(a.attributePrefix)&&c.push(d);return c}function r(b){var c="";return null!=b.__cdata&&(c+="<![CDATA["+b.__cdata+"]]>"),null!=b.__text&&(c+=a.escapeMode?f(b.__text):b.__text),c}function s(b){var c="";return b instanceof Object?c+=r(b):null!=b&&(c+=a.escapeMode?f(b):b),c}function t(a,b,c){var d="";if(0==a.length)d+=l(a,b,c,!0);else for(var e=0;e<a.length;e++)d+=l(a[e],b,q(a[e]),!1),d+=u(a[e]),d+=m(a[e],b);return d}function u(a){var b="",c=p(a);if(c>0)for(var d in a)if(!o(a,d)){var e=a[d],f=q(e);if(null==e||void 0==e)b+=l(e,d,f,!0);else if(e instanceof Object)if(e instanceof Array)b+=t(e,d,f);else if(e instanceof Date)b+=l(e,d,f,!1),b+=e.toISOString(),b+=m(e,d);else{var g=p(e);g>0||null!=e.__text||null!=e.__cdata?(b+=l(e,d,f,!1),b+=u(e),b+=m(e,d)):b+=l(e,d,f,!0)}else b+=l(e,d,f,!1),b+=s(e),b+=m(e,d)}return b+=s(a)}var v="1.1.5";a=a||{},b(),c();var w={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(a){var b=window.ActiveXObject||"ActiveXObject"in window;if(void 0===a)return null;var c;if(window.DOMParser){var d=new window.DOMParser,e=null;if(!b)try{e=d.parseFromString("INVALID","text/xml").childNodes[0].namespaceURI}catch(f){e=null}try{c=d.parseFromString(a,"text/xml"),null!=e&&c.getElementsByTagNameNS(e,"parsererror").length>0&&(c=null)}catch(f){c=null}}else 0==a.indexOf("<?")&&(a=a.substr(a.indexOf("?>")+2)),c=new ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(a);return c},this.asArray=function(a){return a instanceof Array?a:[a]},this.toXmlDateTime=function(a){return a instanceof Date?a.toISOString():"number"==typeof a?new Date(a).toISOString():null},this.asDateTime=function(a){return"string"==typeof a?i(a):a},this.xml2json=function(a){return k(a)},this.xml_str2json=function(a){var b=this.parseXmlString(a);return null!=b?this.xml2json(b):null},this.json2xml_str=function(a){return u(a)},this.json2xml=function(a){var b=this.json2xml_str(a);return this.parseXmlString(b)},this.getVersion=function(){return v}}TGS.Adapters.A0000=function(){TGS.Adapters.A0000.superclass.constructor.call(this),this._mLoggedIn=!1,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1,this._mUseUserInfoInSLB=!0,this._mTesting=!1,this._mMWA=this._mTesting?"//stg-www.mobilewebarcade.com":"//www.mobilewebarcade.com",this._mAccessToken=null},TGS.Adapters.A0000.prototype={autoLogin:function(){return!1},loginIcon:function(){return null},logoutIcon:function(){return null},supportsLogout:function(){return!1},supportsMicrotransactions:function(){return!0},supportsChallenges:function(){return!1},costFactor:function(){return 100},currencyIcon:function(){return TGS._IMAGES_LOCATION+"arcadecredits.png"},formatNumber:function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},priceAsFormattedString:function(a){return this.formatNumber(a*this.costFactor())+" Credits"},connect:function(){var a=getQueryString().access_token;if(a?(this._mAccessToken=a,TGS.Debug.Log(TGS.Debug.LOG_INFO,"access token: "+a)):TGS.Debug.Log(TGS.Debug.LOG_INFO,"no access token was provided, user was not logged in on MWA"),this.onUserInfoAvailable=null,this.getLoginStatus(),this.onUserInfoAvailable=TGS.onUserInfoAvailable,!this._mAccessToken||this._mLoggedIn&&null!==this._mUsername){var b=TGS.localStorage.getItem(TGS._sLSKeys.TGS_userid);this.onUserInfoAvailable(b)}else{var c=this._mMWA+"/wordpress/xmlrpc.php",d='<?xml version="1.0" encoding="iso-8859-1"?><methodCall><methodName>mwa.getUserInfo</methodName><params><param><value><string>'+this._mAccessToken+"</string></value></param></params></methodCall>";TGS.CORSRequest(c,d,!1,!1,this.onGetUserDataSuccess.bind(this),this.onGetUserDataFailed.bind(this))}},onGetUserDataSuccess:function(a){try{var b=new X2JS,c=b.xml_str2json(a);if(""===c.methodResponse.params.param.value.string)return this.onGetUserDataFailed("token was rejected"),void 0;var d=c.methodResponse.params.param.value.array.data.value,e=d[0].string,f=d[1].string,g=d[2].string;this._mUsername="string"==typeof f?f:null,this._mAvatarURL="string"==typeof g?g:null,this.userLoggedIn(null,e),this.onUserInfoAvailable(e)}catch(h){this.onGetUserDataFailed("error converting response xml ("+h.toString()+")")}},onGetUserDataFailed:function(a){TGS.Debug.Log(TGS.Debug.LOG_ERROR,"error getting user data from access token: "+a);var b=TGS.localStorage.getItem(TGS._sLSKeys.TGS_userid);this.onUserInfoAvailable(b)},loginUser:function(){window.open(this._mMWA+"/wp-login.php","_self")},verifyLocalLogin:function(a){null===this._mAccessToken?(TGS.Debug.Log(TGS.Debug.LOG_INFO,"no access token, forcing user logout..."),this.logoutUser()):(TGS.Debug.Log(TGS.Debug.LOG_INFO,"retaining user "+a+" state as logged-in"),this.userLoggedIn(null,a))},purchaseItem:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Requesting users credit balance from TGS..."),a.usingCredits=!0;var b='{"partner":"'+TGS._sPartnerID+'","user":"'+TGS._sUserID+'"}';TGS.SendMessage("mtx/credits","get",b,this._onCheckBalanceSuccess.bind(this,a),this._onCheckBalanceFailure.bind(this,a))},_onCheckBalanceSuccess:function(a,b){var c=b.credits,d=a.item.price*this.costFactor();if(c>=d)TGS.Debug.Log(TGS.Debug.LOG_INFO,"User has enough credits to make purchase, asking for confirmation..."),TGS.OverlayMessage({title:"Confirm Purchase",message:"Do you agree to pay "+this.formatNumber(d)+" Arcade Credits to buy '"+a.item.title+"'? You will have "+this.formatNumber(c-d)+" Arcade Credits remaining.",buttonText:"No",buttonAction:this._onPurchaseCancel.bind(this,a),button2Text:"Yes",button2Callback:this._onPurchaseConfirmed.bind(this,a)});else{TGS.Debug.Log(TGS.Debug.LOG_INFO,"User does not have enough credits"),a.internalErrorMessage="insufficient funds";var e={title:"Insufficient Funds!",message:"You have "+this.formatNumber(c)+" Arcade Credits. You need "+this.formatNumber(d)+" Arcade Credits to purchase this item.",buttonText:"",button2Image:TGS._IMAGES_LOCATION+"get_arcadecredits.png",button2Callback:TGS.Microtransactions.GetCredits};a.userErrorMessage=e,TGS.Microtransactions._PartnerPurchaseFailed(a)}},_onCheckBalanceFailure:function(a,b,c){a.internalErrorMessage="Credit balance check failed","undefined"!=typeof c.message&&(a.internalErrorMessage+=" - "+c.message),TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseCancel:function(a){a.internalErrorMessage="user cancel",a.userErrorMessage="",TGS.Microtransactions._PartnerPurchaseFailed(a)},_onPurchaseConfirmed:function(a){TGS.CloseMessageOverlay(),a.partnerTransactionID="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)}),TGS.Debug.Log(TGS.Debug.LOG_INFO,"User approved purchase of transaction "+a.transactionID),TGS.Microtransactions._PartnerPurchaseSuccessful(a)}},extend(TGS.Adapters.A0000,TGS.PartnerBridge);