/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */
TGS.Adapters.A0003=function(){TGS.Adapters.A0003.superclass.constructor.call(this),this._mLoggedIn=!1,TGS.DataStore._sSaveToLocalStorage=!0,TGS.DataStore._sSaveToTGSServer=!1},TGS.Adapters.A0003.prototype={autoLogin:function(){return!1},loginIcon:function(){return TGS._IMAGES_LOCATION+"facebook_login.png"},supportsMicrotransactions:function(){return!0},costFactor:function(){return 10},priceAsFormattedString:function(a){return"$"+(a*this.costFactor()/100-.01).toFixed(2)},serverHandlesMicrotransactionResponse:function(){return!0},onFacebookLibraryLoaded:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Facebook library loaded successfully"),this._mFacebookLibLoaded=!0,this._mIsReady=!0,this._mFacebookInitialized||this.initFacebook(),null!==this.onAdapterReady&&this.onAdapterReady.call()},initialize:function(){},connect:function(){this.getLoginStatus()},loginUser:function(a){this.loginToFacebook(this.promptForFacebookAuthorization.bind(this,TGS._LoginCanceled.bind(null,a)),this.userLoggedIn.bind(this,a))},logoutUser:function(a){TGS.Adapters.A0003.superclass.logoutUser.call(this,a),FB.logout(function(){window.location.reload()})},loggedIntoFacebook:function(){return this._mLoggedIn},verifyLocalLogin:function(){TGS.Debug.Log(TGS.Debug.LOG_INFO,"user is logged in locally, verifying Facebook authentication..."),this.loginToFacebook(this.logoutUser.bind(this),this.userLoggedIn.bind(this,null))},purchaseItem:function(a){var b=TGS._SERVER_LOCATION+"mtx/facebook/iap_item.php?game="+TGS._sGameID+"&iap_id="+a.item.id;TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,b);var c={method:"pay",action:"purchaseitem",product:b,request_id:a.transactionID};FB.ui(c,this.fbBuyCallback.bind(this,a))},fbBuyCallback:function(a,b){if(TGS.Debug.Log(TGS.Debug.LOG_INFO,"FB data: "+JSON.stringify(b)),b.error_code)return a.internalErrorMessage=b.error_message,1383010===b.error_code&&(a.userErrorMessage=""),TGS.Microtransactions._PartnerPurchaseFailed(a),void 0;if(a.partnerTransactionID=b.payment_id,"completed"===b.status){var c='{"facebook_signed_request":"'+b.signed_request+'","facebook_transaction_id":"'+b.payment_id+'","game":"'+TGS._sGameID+'","user":"'+TGS._sUserID+'","tresensa_transaction_id":'+a.transactionID+',"game_data_changes":'+JSON.stringify(a.gameDataUpdates)+"}";TGS.Debug.Log(TGS.Debug.LOG_VERBOSE,"sending successful purchase data for verification: "+c),TGS.SendMessage("mtx/facebook/callback","verify",c,this._onVerificationSuccess.bind(this,a),this._onVerificationError.bind(this,a))}else"failed"===b.status?(a.internalErrorMessage="failed",TGS.Microtransactions._PartnerPurchaseFailed(a)):"initiated"===b.status&&(a.internalErrorMessage="initiated",TGS.Microtransactions._PartnerPurchaseFailed(a))},_onVerificationSuccess:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Facebook purcahse response was verified"),TGS.Microtransactions._PartnerPurchaseSuccessful(a)},_onVerificationError:function(a){TGS.Debug.Log(TGS.Debug.LOG_INFO,"Facebook response verification failed"),a.internalErrorMessage="Facebook response verification failed",TGS.Microtransactions._PartnerPurchaseFailed(a)}},extend(TGS.Adapters.A0003,TGS.PartnerBridge);